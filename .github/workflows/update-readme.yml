name: Generate Changed File Links

on:
  workflow_dispatch:  # å¯æ‰‹å‹•è§¸ç™¼ï¼ˆä¹Ÿå¯ä»¥æ›æˆ pushã€scheduleï¼‰

jobs:
  generate-links:
    runs-on: ubuntu-latest

    steps:
      # 1. æª¢å‡ºæœ¬ repoï¼ˆgenerate-linkï¼‰
      - name: Checkout current repo (generate-link)
        uses: actions/checkout@v4
        with:
          path: generate-link

      # 2. æª¢å‡ºç›®æ¨™ repoï¼šDr-XYZ/translated-content çš„ temp åˆ†æ”¯
      - name: Checkout translated-content repo (temp branch)
        uses: actions/checkout@v4
        with:
          repository: Dr-XYZ/translated-content
          ref: temp
          token: ${{ secrets.GITHUB_TOKEN }}
          path: translated-content

      # 3. å–å¾—è®Šæ›´çš„æª”æ¡ˆæ¸…å–®ï¼ˆç›¸å°æ–¼ main çš„ merge-baseï¼‰
      - name: Get changed files in translated-content
        working-directory: translated-content
        run: |
          git fetch origin main
          BASE=$(git merge-base origin/main HEAD)
          git diff --name-only $BASE > ../generate-link/changed_files.txt

      # 4. ç”¢ç”Ÿ Markdown é€£çµä¸¦è¦†è“‹ README ä¸­çš„å€å¡Š
      - name: Generate markdown links and update README
        working-directory: generate-link
        run: |
          echo "## ğŸ”— Modified Files" > links.md
          while IFS= read -r file; do
            # è§£æè·¯å¾‘å–å¾— locale èˆ‡ path
            stripped="${file#files/}"
            locale="${stripped%%/*}"
            path="${stripped#*/}"
            path="${path%/index.md}"
            url="https://passionpenguin.github.io/mdn_l10n_helper/#/compare?owner=Dr-XYZ&branch=temp&locale=$locale&path=$path"
            echo "- [$file]($url)" >> links.md
          done < changed_files.txt

          # ç§»é™¤èˆŠå€å¡Šï¼ˆå¾ ## ğŸ”— Modified Files åˆ°ä¸‹ä¸€å€‹æ¨™é¡Œæˆ–æª”æ¡ˆçµå°¾ï¼‰
          if grep -q "## ğŸ”— Modified Files" README.md; then
            awk '/## ğŸ”— Modified Files/ {flag=1; next} /^## / {flag=0} !flag' README.md > README.tmp
            mv README.tmp README.md
          fi

          # é™„åŠ æ–°å€å¡Š
          echo >> README.md
          cat links.md >> README.md

      # 5. Commit ä¸¦æ¨é€è®Šæ›´
      - name: Commit and push to generate-link repo
        working-directory: generate-link
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add README.md
          git commit -m "Update README with links to changed files" || echo "No changes to commit"
          git push origin HEAD
